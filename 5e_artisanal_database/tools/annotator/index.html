<!DOCTYPE html>
<!--
The code for this tool is released under a CC0 1.0 Universal license. You can copy, modify, and distribute this tool, even for commercial purposes, all without asking permission.
Learn about the licensing of the data of this tool in the license.html file located in the root director of this application.
-->
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<meta name="robots" content="noindex">
<meta charset="UTF-8">
<style>
body {
    max-width: 1200px;
    margin: auto;
    font-size: 16px;
    font-family: sans-serif;
    padding: 10px;
    background-color: white;
    color: black;
}

/* Prevent iOS zoom on inputs */
input, button, select, textarea {
    font-size: 16px !important;
}

.controls {
    margin: 10px 0;
    padding: 8px;
    border: 1px solid #999;
    background-color: #e8e8e8;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}

.controls h3 {
    margin: 0;
    font-size: 16px;
    width: 100%;
}

.controls input, .controls button {
    margin: 2px;
    padding: 6px;
    font-size: 16px;
}

.controls input[type="file"] {
    background-color: white;
    color: black;
    border: 1px solid #999;
}

.controls input[type="text"], .controls input[type="number"] {
    background-color: white;
    color: black;
    border: 1px solid #999;
    width: 150px;
}

.controls button {
    background-color: #666;
    color: white;
    border: none;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 16px;
}

.controls button:hover {
    background-color: #555;
}

.controls button.active {
    background-color: #444;
}

.map-container {
    position: relative;
    margin: 20px 0;
    border: 2px solid #999;
    background-color: #f0f0f0;
    min-height: 400px;
    overflow: auto;
    max-height: 80vh;
}

.map-canvas {
    position: relative;
    display: inline-block;
    cursor: crosshair;
}

.map-image {
    display: block;
    max-width: 100%;
    height: auto;
}

.text-label {
    position: absolute;
    color: black;
    font-weight: bold;
    text-shadow: 
        -1px -1px 0 white,
        1px -1px 0 white,
        -1px 1px 0 white,
        1px 1px 0 white,
        -2px 0 0 white,
        2px 0 0 white,
        0 -2px 0 white,
        0 2px 0 white;
    cursor: move;
    user-select: none;
    transform: translate(-50%, -50%);
    z-index: 10;
    font-family: Arial, sans-serif;
    white-space: nowrap;
}

.text-label:hover {
    outline: 2px dashed #666;
}

.text-label.selected {
    outline: 2px solid #007acc;
}

.label-controls {
    margin: 10px 0;
    padding: 8px;
    border: 1px solid #999;
    background-color: #f9f9f9;
    display: none;
}

.label-controls.active {
    display: block;
}

.label-controls input {
    background-color: white;
    color: black;
    border: 1px solid #999;
    padding: 4px;
    margin: 2px;
}

.no-map {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 60px 20px;
}

.size-control {
    display: flex;
    align-items: center;
    gap: 5px;
}

.file-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}
</style>
<title>Map Annotator - 5e Artisanal Database</title>
</head>
<body>
<p><a href="../../index.html">5e Artisanal Database</a> â†’ Map Annotator</p>

<h1>Map Annotator</h1>

<div class="controls">
    <h3>Load Map</h3>
    <div class="file-controls">
        <input type="file" id="mapFile" accept="image/*" onchange="loadMap(event)">
        <button onclick="clearMap()">Clear Map</button>
        <button onclick="exportMap()">Export Annotated Map</button>
        <button onclick="saveProject()">Save Project</button>
        <input type="file" id="projectFile" accept=".json" style="display: none" onchange="loadProject(event)">
        <button onclick="document.getElementById('projectFile').click()">Load Project</button>
    </div>
</div>

<div class="controls">
    <h3>Add Labels</h3>
    <input type="text" id="labelText" placeholder="Label text" maxlength="50">
    <div class="size-control">
        <label>Size:</label>
        <input type="number" id="labelSize" value="16" min="8" max="72" step="2">
        <span>px</span>
    </div>
    <button id="addMode" onclick="toggleAddMode()" class="active">Add Mode: ON</button>
    <button onclick="clearAllLabels()">Clear All Labels</button>
</div>

<div id="labelControls" class="label-controls">
    <h4>Edit Selected Label</h4>
    <input type="text" id="editLabelText" placeholder="Label text">
    <div class="size-control">
        <label>Size:</label>
        <input type="number" id="editLabelSize" min="8" max="72" step="2">
        <span>px</span>
    </div>
    <button onclick="updateSelectedLabel()">Update</button>
    <button onclick="deleteSelectedLabel()">Delete</button>
    <button onclick="deselectLabel()">Done</button>
</div>

<div id="mapContainer" class="map-container">
    <div class="no-map">Load a map image (JPG or PNG) to start adding labels</div>
</div>

<script>
let currentMap = null;
let labels = [];
let selectedLabel = null;
let addModeEnabled = true;
let labelIdCounter = 1;

function loadMap(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file (JPG or PNG).');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const container = document.getElementById('mapContainer');
        
        // Create canvas container
        const canvas = document.createElement('div');
        canvas.className = 'map-canvas';
        canvas.onclick = handleCanvasClick;
        
        // Create image
        const img = document.createElement('img');
        img.className = 'map-image';
        img.src = e.target.result;
        img.onload = function() {
            currentMap = {
                src: e.target.result,
                width: img.naturalWidth,
                height: img.naturalHeight,
                filename: file.name
            };
        };
        
        canvas.appendChild(img);
        container.innerHTML = '';
        container.appendChild(canvas);
        
        // Clear existing labels
        labels = [];
        selectedLabel = null;
        hideEditControls();
    };
    
    reader.readAsDataURL(file);
}

function handleCanvasClick(event) {
    if (!addModeEnabled || !currentMap) return;
    
    const labelText = document.getElementById('labelText').value.trim();
    if (!labelText) {
        alert('Please enter label text first.');
        document.getElementById('labelText').focus();
        return;
    }
    
    const canvas = event.currentTarget;
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    
    // Calculate position relative to the actual image
    const img = canvas.querySelector('.map-image');
    const imgRect = img.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    
    const relativeX = event.clientX - imgRect.left;
    const relativeY = event.clientY - imgRect.top;
    
    // Make sure click is within image bounds
    if (relativeX < 0 || relativeY < 0 || relativeX > img.width || relativeY > img.height) {
        return;
    }
    
    addLabel(relativeX, relativeY, labelText);
    
    // Clear the input
    document.getElementById('labelText').value = '';
    document.getElementById('labelText').focus();
}

function addLabel(x, y, text) {
    const size = parseInt(document.getElementById('labelSize').value) || 16;
    
    const label = {
        id: labelIdCounter++,
        x: x,
        y: y,
        text: text,
        size: size
    };
    
    labels.push(label);
    renderLabels();
}

function renderLabels() {
    const canvas = document.querySelector('.map-canvas');
    if (!canvas) return;
    
    // Remove existing label elements
    const existingLabels = canvas.querySelectorAll('.text-label');
    existingLabels.forEach(label => label.remove());
    
    // Add all labels
    labels.forEach(label => {
        const labelElement = document.createElement('div');
        labelElement.className = 'text-label';
        labelElement.textContent = label.text;
        labelElement.style.left = label.x + 'px';
        labelElement.style.top = label.y + 'px';
        labelElement.style.fontSize = label.size + 'px';
        labelElement.dataset.labelId = label.id;
        
        // Add click handler for selection
        labelElement.onclick = function(e) {
            e.stopPropagation();
            selectLabel(label.id);
        };
        
        // Add drag functionality
        makeDraggable(labelElement, label);
        
        if (selectedLabel && selectedLabel.id === label.id) {
            labelElement.classList.add('selected');
        }
        
        canvas.appendChild(labelElement);
    });
}

function makeDraggable(element, label) {
    let isDragging = false;
    let startX, startY, startLeft, startTop;
    
    element.onmousedown = function(e) {
        if (e.button !== 0) return; // Only left mouse button
        
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = label.x;
        startTop = label.y;
        
        document.onmousemove = function(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            label.x = startLeft + deltaX;
            label.y = startTop + deltaY;
            
            element.style.left = label.x + 'px';
            element.style.top = label.y + 'px';
            
            e.preventDefault();
        };
        
        document.onmouseup = function() {
            isDragging = false;
            document.onmousemove = null;
            document.onmouseup = null;
        };
        
        e.preventDefault();
        e.stopPropagation();
    };
}

function selectLabel(labelId) {
    selectedLabel = labels.find(label => label.id === labelId);
    if (selectedLabel) {
        document.getElementById('editLabelText').value = selectedLabel.text;
        document.getElementById('editLabelSize').value = selectedLabel.size;
        showEditControls();
        renderLabels(); // Re-render to show selection
    }
}

function deselectLabel() {
    selectedLabel = null;
    hideEditControls();
    renderLabels();
}

function showEditControls() {
    document.getElementById('labelControls').classList.add('active');
}

function hideEditControls() {
    document.getElementById('labelControls').classList.remove('active');
}

function updateSelectedLabel() {
    if (!selectedLabel) return;
    
    const newText = document.getElementById('editLabelText').value.trim();
    const newSize = parseInt(document.getElementById('editLabelSize').value) || 16;
    
    if (!newText) {
        alert('Label text cannot be empty.');
        return;
    }
    
    selectedLabel.text = newText;
    selectedLabel.size = newSize;
    renderLabels();
}

function deleteSelectedLabel() {
    if (!selectedLabel) return;
    
    if (confirm('Delete this label?')) {
        labels = labels.filter(label => label.id !== selectedLabel.id);
        selectedLabel = null;
        hideEditControls();
        renderLabels();
    }
}

function toggleAddMode() {
    addModeEnabled = !addModeEnabled;
    const button = document.getElementById('addMode');
    
    if (addModeEnabled) {
        button.textContent = 'Add Mode: ON';
        button.classList.add('active');
        document.querySelector('.map-canvas').style.cursor = 'crosshair';
    } else {
        button.textContent = 'Add Mode: OFF';
        button.classList.remove('active');
        document.querySelector('.map-canvas').style.cursor = 'default';
    }
}

function clearAllLabels() {
    if (labels.length === 0) {
        alert('No labels to clear.');
        return;
    }
    
    if (confirm(`Delete all ${labels.length} labels?`)) {
        labels = [];
        selectedLabel = null;
        hideEditControls();
        renderLabels();
    }
}

function clearMap() {
    if (confirm('Clear the current map and all labels?')) {
        currentMap = null;
        labels = [];
        selectedLabel = null;
        hideEditControls();
        document.getElementById('mapContainer').innerHTML = '<div class="no-map">Load a map image (JPG or PNG) to start adding labels</div>';
        document.getElementById('mapFile').value = '';
    }
}

function exportMap() {
    if (!currentMap || labels.length === 0) {
        alert('No map or labels to export.');
        return;
    }
    
    // Create a canvas to draw the map and labels
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Create image element
    const img = new Image();
    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        
        // Draw the map
        ctx.drawImage(img, 0, 0);
        
        // Draw labels
        labels.forEach(label => {
            ctx.font = `bold ${label.size}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Draw white outline (stroke)
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.strokeText(label.text, label.x, label.y);
            
            // Draw black text (fill)
            ctx.fillStyle = 'black';
            ctx.fillText(label.text, label.x, label.y);
        });
        
        // Download the result
        canvas.toBlob(function(blob) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const filename = currentMap.filename.replace(/\.[^/.]+$/, '') + '_annotated.png';
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        });
    };
    
    img.src = currentMap.src;
}

function saveProject() {
    if (!currentMap) {
        alert('No map loaded to save.');
        return;
    }
    
    const projectData = {
        map: currentMap,
        labels: labels,
        version: '1.0',
        savedDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(projectData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    const filename = currentMap.filename.replace(/\.[^/.]+$/, '') + '_project.json';
    link.download = filename;
    link.click();
    
    URL.revokeObjectURL(link.href);
}

function loadProject(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const projectData = JSON.parse(e.target.result);
            
            if (!projectData.map || !projectData.labels) {
                alert('Invalid project file format.');
                return;
            }
            
            // Load the map
            currentMap = projectData.map;
            
            const container = document.getElementById('mapContainer');
            const canvas = document.createElement('div');
            canvas.className = 'map-canvas';
            canvas.onclick = handleCanvasClick;
            
            const img = document.createElement('img');
            img.className = 'map-image';
            img.src = currentMap.src;
            
            canvas.appendChild(img);
            container.innerHTML = '';
            container.appendChild(canvas);
            
            // Load labels
            labels = projectData.labels;
            if (labels.length > 0) {
                labelIdCounter = Math.max(...labels.map(l => l.id)) + 1;
            }
            
            selectedLabel = null;
            hideEditControls();
            
            // Wait for image to load before rendering labels
            img.onload = function() {
                renderLabels();
            };
            
        } catch (error) {
            alert('Error loading project file.');
            console.error('Load error:', error);
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

// Handle Enter key in inputs
document.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        const activeElement = document.activeElement;
        
        if (activeElement.id === 'labelText' && addModeEnabled && currentMap) {
            // Focus stays on input for quick labeling
            document.getElementById('labelText').focus();
        }
    }
});

// Handle Escape key to deselect
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && selectedLabel) {
        deselectLabel();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('labelText').focus();
});
</script>

<p>This tool is released under a <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0 1.0 Universal</a> license. You can copy, modify, and distribute this tool, even for commercial purposes, all without asking permission.</p>

</body>
</html>