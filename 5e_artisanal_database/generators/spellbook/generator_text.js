// 5.1 SRD Wizard Spells Data
const wizardSpells = {
    0: [
        {name: "Acid Splash", slug: "acid-splash"},
        {name: "Dancing Lights", slug: "dancing-lights"},
        {name: "Fire Bolt", slug: "fire-bolt"},
        {name: "Light", slug: "light"},
        {name: "Mage Hand", slug: "mage-hand"},
        {name: "Mending", slug: "mending"},
        {name: "Message", slug: "message"},
        {name: "Minor Illusion", slug: "minor-illusion"},
        {name: "Poison Spray", slug: "poison-spray"},
        {name: "Prestidigitation", slug: "prestidigitation"},
        {name: "Ray of Frost", slug: "ray-of-frost"},
        {name: "Shocking Grasp", slug: "shocking-grasp"}
    ],
    1: [
        {name: "Alarm", slug: "alarm"},
        {name: "Burning Hands", slug: "burning-hands"},
        {name: "Charm Person", slug: "charm-person"},
        {name: "Color Spray", slug: "color-spray"},
        {name: "Comprehend Languages", slug: "comprehend-languages"},
        {name: "Detect Magic", slug: "detect-magic"},
        {name: "Disguise Self", slug: "disguise-self"},
        {name: "Expeditious Retreat", slug: "expeditious-retreat"},
        {name: "False Life", slug: "false-life"},
        {name: "Feather Fall", slug: "feather-fall"},
        {name: "Find Familiar", slug: "find-familiar"},
        {name: "Floating Disk", slug: "floating-disk"},
        {name: "Fog Cloud", slug: "fog-cloud"},
        {name: "Grease", slug: "grease"},
        {name: "Hold Person", slug: "hold-person"},
        {name: "Identify", slug: "identify"},
        {name: "Jump", slug: "jump"},
        {name: "Longstrider", slug: "longstrider"},
        {name: "Mage Armor", slug: "mage-armor"},
        {name: "Magic Missile", slug: "magic-missile"},
        {name: "Protection from Evil and Good", slug: "protection-from-evil-and-good"},
        {name: "Shield", slug: "shield"},
        {name: "Silent Image", slug: "silent-image"},
        {name: "Sleep", slug: "sleep"},
        {name: "Thunderwave", slug: "thunderwave"},
        {name: "Unseen Servant", slug: "unseen-servant"}
    ],
    2: [
        {name: "Acid Arrow", slug: "acid-arrow"},
        {name: "Alter Self", slug: "alter-self"},
        {name: "Arcane Lock", slug: "arcane-lock"},
        {name: "Blindness/Deafness", slug: "blindnessdeafness"},
        {name: "Blur", slug: "blur"},
        {name: "Cloud of Daggers", slug: "cloud-of-daggers"},
        {name: "Continual Flame", slug: "continual-flame"},
        {name: "Darkness", slug: "darkness"},
        {name: "Darkvision", slug: "darkvision"},
        {name: "Detect Thoughts", slug: "detect-thoughts"},
        {name: "Enlarge/Reduce", slug: "enlargereduce"},
        {name: "Flaming Sphere", slug: "flaming-sphere"},
        {name: "Gentle Repose", slug: "gentle-repose"},
        {name: "Gust of Wind", slug: "gust-of-wind"},
        {name: "Hold Person", slug: "hold-person"},
        {name: "Invisibility", slug: "invisibility"},
        {name: "Knock", slug: "knock"},
        {name: "Levitate", slug: "levitate"},
        {name: "Locate Object", slug: "locate-object"},
        {name: "Magic Mouth", slug: "magic-mouth"},
        {name: "Magic Weapon", slug: "magic-weapon"},
        {name: "Mirror Image", slug: "mirror-image"},
        {name: "Misty Step", slug: "misty-step"},
        {name: "Ray of Enfeeblement", slug: "ray-of-enfeeblement"},
        {name: "Rope Trick", slug: "rope-trick"},
        {name: "Scorching Ray", slug: "scorching-ray"},
        {name: "See Invisibility", slug: "see-invisibility"},
        {name: "Shatter", slug: "shatter"},
        {name: "Spider Climb", slug: "spider-climb"},
        {name: "Suggestion", slug: "suggestion"},
        {name: "Web", slug: "web"}
    ],
    3: [
        {name: "Animate Dead", slug: "animate-dead"},
        {name: "Bestow Curse", slug: "bestow-curse"},
        {name: "Blink", slug: "blink"},
        {name: "Clairvoyance", slug: "clairvoyance"},
        {name: "Counterspell", slug: "counterspell"},
        {name: "Dispel Magic", slug: "dispel-magic"},
        {name: "Fear", slug: "fear"},
        {name: "Fireball", slug: "fireball"},
        {name: "Fly", slug: "fly"},
        {name: "Gaseous Form", slug: "gaseous-form"},
        {name: "Glyph of Warding", slug: "glyph-of-warding"},
        {name: "Haste", slug: "haste"},
        {name: "Hold Person", slug: "hold-person"},
        {name: "Hypnotic Pattern", slug: "hypnotic-pattern"},
        {name: "Lightning Bolt", slug: "lightning-bolt"},
        {name: "Magic Circle", slug: "magic-circle"},
        {name: "Major Image", slug: "major-image"},
        {name: "Nondetection", slug: "nondetection"},
        {name: "Phantom Steed", slug: "phantom-steed"},
        {name: "Protection from Energy", slug: "protection-from-energy"},
        {name: "Remove Curse", slug: "remove-curse"},
        {name: "Sending", slug: "sending"},
        {name: "Sleet Storm", slug: "sleet-storm"},
        {name: "Slow", slug: "slow"},
        {name: "Stinking Cloud", slug: "stinking-cloud"},
        {name: "Tongues", slug: "tongues"},
        {name: "Vampiric Touch", slug: "vampiric-touch"},
        {name: "Water Breathing", slug: "water-breathing"}
    ],
    4: [
        {name: "Arcane Eye", slug: "arcane-eye"},
        {name: "Banishment", slug: "banishment"},
        {name: "Black Tentacles", slug: "black-tentacles"},
        {name: "Blight", slug: "blight"},
        {name: "Confusion", slug: "confusion"},
        {name: "Conjure Minor Elementals", slug: "conjure-minor-elementals"},
        {name: "Control Water", slug: "control-water"},
        {name: "Dimension Door", slug: "dimension-door"},
        {name: "Fabricate", slug: "fabricate"},
        {name: "Fire Shield", slug: "fire-shield"},
        {name: "Greater Invisibility", slug: "greater-invisibility"},
        {name: "Hallucinatory Terrain", slug: "hallucinatory-terrain"},
        {name: "Ice Storm", slug: "ice-storm"},
        {name: "Locate Creature", slug: "locate-creature"},
        {name: "Phantasmal Killer", slug: "phantasmal-killer"},
        {name: "Polymorph", slug: "polymorph"},
        {name: "Private Sanctum", slug: "private-sanctum"},
        {name: "Resilient Sphere", slug: "resilient-sphere"},
        {name: "Secret Chest", slug: "secret-chest"},
        {name: "Stone Shape", slug: "stone-shape"},
        {name: "Stoneskin", slug: "stoneskin"},
        {name: "Wall of Fire", slug: "wall-of-fire"}
    ],
    5: [
        {name: "Animate Objects", slug: "animate-objects"},
        {name: "Arcane Hand", slug: "arcane-hand"},
        {name: "Cloudkill", slug: "cloudkill"},
        {name: "Cone of Cold", slug: "cone-of-cold"},
        {name: "Conjure Elemental", slug: "conjure-elemental"},
        {name: "Contact Other Plane", slug: "contact-other-plane"},
        {name: "Creation", slug: "creation"},
        {name: "Dominate Person", slug: "dominate-person"},
        {name: "Dream", slug: "dream"},
        {name: "Hold Monster", slug: "hold-monster"},
        {name: "Legend Lore", slug: "legend-lore"},
        {name: "Mislead", slug: "mislead"},
        {name: "Modify Memory", slug: "modify-memory"},
        {name: "Passwall", slug: "passwall"},
        {name: "Planar Binding", slug: "planar-binding"},
        {name: "Scrying", slug: "scrying"},
        {name: "Seeming", slug: "seeming"},
        {name: "Telekinesis", slug: "telekinesis"},
        {name: "Telepathic Bond", slug: "telepathic-bond"},
        {name: "Teleportation Circle", slug: "teleportation-circle"},
        {name: "Wall of Force", slug: "wall-of-force"},
        {name: "Wall of Stone", slug: "wall-of-stone"}
    ],
    6: [
        {name: "Arcane Gate", slug: "arcane-gate"},
        {name: "Circle of Death", slug: "circle-of-death"},
        {name: "Contingency", slug: "contingency"},
        {name: "Create Undead", slug: "create-undead"},
        {name: "Disintegrate", slug: "disintegrate"},
        {name: "Eyebite", slug: "eyebite"},
        {name: "Flesh to Stone", slug: "flesh-to-stone"},
        {name: "Globe of Invulnerability", slug: "globe-of-invulnerability"},
        {name: "Guards and Wards", slug: "guards-and-wards"},
        {name: "Magic Jar", slug: "magic-jar"},
        {name: "Mass Suggestion", slug: "mass-suggestion"},
        {name: "Move Earth", slug: "move-earth"},
        {name: "Programmed Illusion", slug: "programmed-illusion"},
        {name: "Sunbeam", slug: "sunbeam"},
        {name: "True Seeing", slug: "true-seeing"},
        {name: "Wall of Ice", slug: "wall-of-ice"}
    ],
    7: [
        {name: "Arcane Sword", slug: "arcane-sword"},
        {name: "Delayed Blast Fireball", slug: "delayed-blast-fireball"},
        {name: "Etherealness", slug: "etherealness"},
        {name: "Finger of Death", slug: "finger-of-death"},
        {name: "Forcecage", slug: "forcecage"},
        {name: "Mirage Arcane", slug: "mirage-arcane"},
        {name: "Plane Shift", slug: "plane-shift"},
        {name: "Prismatic Spray", slug: "prismatic-spray"},
        {name: "Project Image", slug: "project-image"},
        {name: "Reverse Gravity", slug: "reverse-gravity"},
        {name: "Sequester", slug: "sequester"},
        {name: "Simulacrum", slug: "simulacrum"},
        {name: "Symbol", slug: "symbol"},
        {name: "Teleport", slug: "teleport"}
    ],
    8: [
        {name: "Antimagic Field", slug: "antimagic-field"},
        {name: "Antipathy/Sympathy", slug: "antipathysympathy"},
        {name: "Clone", slug: "clone"},
        {name: "Control Weather", slug: "control-weather"},
        {name: "Demiplane", slug: "demiplane"},
        {name: "Dominate Monster", slug: "dominate-monster"},
        {name: "Feeblemind", slug: "feeblemind"},
        {name: "Incendiary Cloud", slug: "incendiary-cloud"},
        {name: "Maze", slug: "maze"},
        {name: "Mind Blank", slug: "mind-blank"},
        {name: "Power Word Stun", slug: "power-word-stun"},
        {name: "Sunburst", slug: "sunburst"}
    ],
    9: [
        {name: "Astral Projection", slug: "astral-projection"},
        {name: "Foresight", slug: "foresight"},
        {name: "Gate", slug: "gate"},
        {name: "Imprisonment", slug: "imprisonment"},
        {name: "Meteor Swarm", slug: "meteor-swarm"},
        {name: "Power Word Kill", slug: "power-word-kill"},
        {name: "Prismatic Wall", slug: "prismatic-wall"},
        {name: "Shapechange", slug: "shapechange"},
        {name: "Time Stop", slug: "time-stop"},
        {name: "True Polymorph", slug: "true-polymorph"},
        {name: "Wish", slug: "wish"}
    ]
};

// Wizard spell progression data
const wizardProgression = {
    1: { spellbook: 6, maxLevel: 1, cantrips: 3 },
    2: { spellbook: 8, maxLevel: 1, cantrips: 3 },
    3: { spellbook: 10, maxLevel: 2, cantrips: 3 },
    4: { spellbook: 12, maxLevel: 2, cantrips: 4 },
    5: { spellbook: 14, maxLevel: 3, cantrips: 4 },
    6: { spellbook: 16, maxLevel: 3, cantrips: 4 },
    7: { spellbook: 18, maxLevel: 4, cantrips: 4 },
    8: { spellbook: 20, maxLevel: 4, cantrips: 4 },
    9: { spellbook: 22, maxLevel: 5, cantrips: 4 },
    10: { spellbook: 24, maxLevel: 5, cantrips: 5 },
    11: { spellbook: 26, maxLevel: 6, cantrips: 5 },
    12: { spellbook: 28, maxLevel: 6, cantrips: 5 },
    13: { spellbook: 30, maxLevel: 7, cantrips: 5 },
    14: { spellbook: 32, maxLevel: 7, cantrips: 5 },
    15: { spellbook: 34, maxLevel: 8, cantrips: 5 },
    16: { spellbook: 36, maxLevel: 8, cantrips: 5 },
    17: { spellbook: 38, maxLevel: 9, cantrips: 5 },
    18: { spellbook: 40, maxLevel: 9, cantrips: 5 },
    19: { spellbook: 42, maxLevel: 9, cantrips: 5 },
    20: { spellbook: 44, maxLevel: 9, cantrips: 5 }
};

// Custom generation function for spellbook
function generateSpellbook() {
    const wizardLevel = parseInt(document.getElementById('wizard-level').value);
    
    const progression = wizardProgression[wizardLevel];
    const maxLevel = progression.maxLevel;
    const spellCount = progression.spellbook;
    
    // Generate spell list
    const spells = generateWizardSpells(maxLevel, spellCount, progression.cantrips);
    
    // Create output HTML
    let output = '<div style="line-height: 1.6;"><h2>Spells</h2><ol>';
    
    spells.forEach(spell => {
        const levelText = spell.level === 0 ? 'Cantrip' : `${spell.level}${getOrdinalSuffix(spell.level)} level`;
        output += `<li><em><a href="../../spells/html/5.1_srd_(d&d_2014)/${spell.slug}.html" target="_blank">${spell.name}</a></em> (${levelText})</li>`;
    });
    
    output += '</ol></div>';
    
    document.getElementById('output').innerHTML = output;
}

function generateWizardSpells(maxLevel, spellCount, cantripCount) {
    const selectedSpells = [];
    const usedSpells = new Set();
    
    // Step 1: Ensure we have the required cantrips
    const cantripPool = [...wizardSpells[0]].sort(() => 0.5 - Math.random());
    for (let i = 0; i < Math.min(cantripCount, cantripPool.length); i++) {
        selectedSpells.push({...cantripPool[i], level: 0});
        usedSpells.add(cantripPool[i].slug);
    }
    
    // Step 2: Ensure at least one spell of each level they can cast (1-maxLevel)
    for (let level = 1; level <= maxLevel; level++) {
        if (wizardSpells[level] && wizardSpells[level].length > 0) {
            const levelPool = wizardSpells[level].filter(spell => !usedSpells.has(spell.slug));
            if (levelPool.length > 0) {
                const randomSpell = levelPool[Math.floor(Math.random() * levelPool.length)];
                selectedSpells.push({...randomSpell, level: level});
                usedSpells.add(randomSpell.slug);
            }
        }
    }
    
    // Step 3: Fill remaining slots with weighted distribution
    const remainingSlots = spellCount - selectedSpells.length;
    
    if (remainingSlots > 0) {
        const levelWeights = {
            1: 4,  // 1st level spells are very common
            2: 3,  // 2nd level spells are common
            3: 2,  // 3rd level spells are less common
            4: 2,  // 4th level spells are less common
            5: 1,  // 5th level spells are rare
            6: 1,  // 6th level spells are rare
            7: 1,  // 7th level spells are very rare
            8: 1,  // 8th level spells are very rare
            9: 1   // 9th level spells are extremely rare
        };
        
        // Create weighted pool of remaining spells
        let spellPool = [];
        for (let level = 1; level <= maxLevel; level++) {
            if (wizardSpells[level]) {
                const weight = levelWeights[level] || 1;
                wizardSpells[level].forEach(spell => {
                    if (!usedSpells.has(spell.slug)) {
                        // Add each spell multiple times based on weight
                        for (let i = 0; i < weight; i++) {
                            spellPool.push({...spell, level: level});
                        }
                    }
                });
            }
        }
        
        // Shuffle and select remaining spells
        const shuffled = spellPool.sort(() => 0.5 - Math.random());
        let addedCount = 0;
        for (let i = 0; i < shuffled.length && addedCount < remainingSlots; i++) {
            const spell = shuffled[i];
            if (!usedSpells.has(spell.slug)) {
                selectedSpells.push(spell);
                usedSpells.add(spell.slug);
                addedCount++;
            }
        }
        
        // If we still don't have enough spells, add any remaining available spells
        if (selectedSpells.length < spellCount) {
            for (let level = 0; level <= maxLevel; level++) {
                if (wizardSpells[level] && selectedSpells.length < spellCount) {
                    wizardSpells[level].forEach(spell => {
                        if (!usedSpells.has(spell.slug) && selectedSpells.length < spellCount) {
                            selectedSpells.push({...spell, level: level});
                            usedSpells.add(spell.slug);
                        }
                    });
                }
            }
        }
    }
    
    // Sort by level, then by name
    selectedSpells.sort((a, b) => {
        if (a.level !== b.level) {
            return a.level - b.level;
        }
        return a.name.localeCompare(b.name);
    });
    
    return selectedSpells;
}

function getOrdinalSuffix(num) {
    const j = num % 10;
    const k = num % 100;
    if (j == 1 && k != 11) return "st";
    if (j == 2 && k != 12) return "nd";
    if (j == 3 && k != 13) return "rd";
    return "th";
}